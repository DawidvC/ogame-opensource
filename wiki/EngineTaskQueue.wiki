#summary Описание движка игровых событий

= Глобальная очередь событий. =

Вкратце - это большая таблица внутри игры, где написано что и когда должно завершится у игроков.

Программный модуль находится в файле `game/queue.php`

Временной поток игры состоит из отрезков времени, между двумя событиями, которые влияют на состояние аккаунтов игроков.<br>
События всех игроков выстраиваются в общую очередь. Очередь дискретна - каждое событие синхронизировано посекундно.<br>
Проверка на завершение события (движение очереди) осуществляется когда игроки совершаются какие-либо действия (переходят по страницам).<br>
Если два события попадают на одну секунду, то они обрабатываются в порядке приоритета (например если Атака совпадает по времени с Переработать,
на тех же координатах, то вначале обрабатывается Атака, а потом Переработать).

Каждое событие имеет начало (время запуска) и конец (время завершения события). Некоторые события можно отменить. Отмена некоторых событий порождает 
другие события (например отмена задания флота порождает новое задание возврата флота).

Главные типы событий аккаунта:
 * Счётчики времени на аккаунте игрока (действие офицеров, удаление аккаунта итп.)
 * Строительство на планете/луне
 * Исследование
 * Строительство на верфи
 * Задания для флота и МПР
 * Глобальные события для всех игроков (релогин, чистка виртуального лома, удаление уничтоженных планет, пересчёт очков 3 раза в сутки итп.)

Пересчёт очков: 8:05, 16:05, 20:05 по серверу

Как происходит обновление очереди:<br>
После очередного клика одного из юзеров проверяется каждое задание очереди на завершение. Если задание завершено - вызывается его обработчик и задание
удаляется из очереди.

= Таблица событий =

Таблица `queue` представляет собой глобальную очередь событий. Формат таблицы:

|| *столбец* || *SQL тип* || *описание* ||
|| task_id || INT PRIMARY KEY || уникальный номер задания ||
|| owner_id || INT || номер пользователя которому принадлежит задание ||
|| type || CHAR(20) || тип задания, каждый тип имеет свой обработчик ||
|| sub_id || INT || дополнительный номер, разный у каждого типа задания, например для постройки - ID планеты, для задания флота - ID флота||
|| obj_id|| INT|| дополнительный номер, разный у каждого типа задания, например для постройки - ID здания||
|| level|| INT|| уровень постройки / количество заказанных единиц на верфи ||
|| start || INT UNSIGNED || время начала задания time()||
|| end || INT UNSIGNED || время окончания задания time()||
|| prio || INT || приоритет события, используется для событий, которые заканчиваются в одно и тоже время, чем выше приоритет, тем раньше выполнится событие||

= Типы событий =

|| *тип* || *sub_id* || *obj_id* || *описание* ||
||`CommanderOff`|| || ||заканчивается офицер: Командир||
||`AdmiralOff`|| || ||заканчивается офицер: Адмирал||
||`EngineerOff`|| || ||заканчивается офицер: Инженер||
||`GeologeOff`|| || ||заканчивается офицер: Геолог||
||`TechnocrateOff`|| || ||заканчивается офицер: Технократ||
||`DeleteAccount`|| || ||удалить аккаунт||
||`UnbanPlayer`|| || ||разбанить игрока||
||`ChangeEmail`|| || ||сменить почтовый адрес||
||`AllowName`|| || ||разрешить смену имени игрока||
||`AllowAttacks`|| || ||отменить запрет атак у игрока||
||`UnloadAll`|| || ||сделать релогин всех игроков||
||`CleanDebris`|| || ||чистка виртуальных полей обломков||
||`CleanPlanets`|| || ||удаление уничтоженных планет / покинутых лун||
||`UpdateStats`|| || ||пересчёт статистики игроков||
||`Build`||номер планеты||тип постройки||постройка на планете||
||`Demolish`||номер планеты||тип постройки||снос на планете||
||`Research`||номер планеты где было запущено исследование||тип исследования||исследование||
||`Shipyard`||номер планеты||тип постройки||задание для верфи||
||`FleetXXX`||номер записи в таблице флотов|| ||Задание флота / Атака МПР||
||`DecRes`||номер задания постройки для определения количества ресурсов|| ||Списать ресурсы на планете||